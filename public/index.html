<!doctype html>
<html lang="en">

<head>
  <title>SogeBot - WebPanel</title>
  <meta charset="utf-8">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#f4f5f6">
  <meta name="apple-mobile-web-app-status-bar-style" content="#f4f5f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">  <link href="https://fonts.googleapis.com/css?family=Catamaran:900" rel="stylesheet">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="./dist/bootstrap/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/zabuto_calendar/1.2.1/zabuto_calendar.min.css" />
  <link rel="stylesheet" href="./dist/css/sortable-theme-bootstrap.css">
  <link rel="stylesheet" href="./dist/bootstrap-toggle/css/bootstrap-toggle.min.css" />
  <link rel="stylesheet" href="./dist/css/custom.css">
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <div class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
        <a class="navbar-brand" href="#">SogeBot WebPanel</a>
      </div>

      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav" id="menu-main">
          <li id="menuDashboard"><a href="#" data-page="dashboard" class="active">Dashboard</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Systems <span class="caret"></span></a>
            <ul class="dropdown-menu" id="menu-systems"></ul>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- SNIPPETS -->
  <div class="stream-info-container col-xs-12 col-sm-12 col-md-12">
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Game</h2>
      <span class="data" id="game">Not Available</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Uptime</h2>
      <span class="data" id="uptime">--:--:--</span>
      <span class="stats">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Viewers</h2>
      <span class="data curViewers">-</span>
      <span class="stats">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Max Viewers</h2>
      <span class="data" id="maxViewers">-</span>
      <span class="stats" id="maxViewersChange">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>New Chatters</h2>
      <span class="data" id="newChtr">-</span>
      <span class="stats" id="newChtrChange">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Chat Messages</h2>
      <span class="data" id="totalChatMsgs">-</span>
      <span class="stats" id="totalChatMsgsChange">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-4">
      <h2>Title</h2>
      <span class="data" id="title">Not Available</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Views</h2>
      <span class="data" id="curViews">-</span>
      <span class="stats" id="curViewsChange">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Hosts</h2>
      <span class="data" id="curHosts">-</span>
      <span class="stats" id="curHostsChange">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Followers</h2>
      <span class="data"><span id="curFollowers">-</span></span>
      <span class="stats" id="curFollowersChange">&nbsp;</span>
    </div>
    <div class="stream-info col-xs-6 col-sm-4 col-md-2">
      <h2>Status</h2>
      <span class="data" style="font-weight: bold">
        <span class="text-warning" id="APIStatus" title="API checking">API</span>
        <span class="text-warning" id="TMIStatus" title="TMI checking">TMI</span>
        <span class="text-warning" id="SOCStatus" title="SOC checking">SOC</span>
        <span class="text-warning" id="MODStatus" title="MOD checking">MOD</span>
      </span>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-12 col-sm-12 col-md-12">
        <!-- widgets -->
        <div class="widgets">
          <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4" id="widgetRow1"></div>
          <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4" id="widgetRow2"></div>
          <div class="col-xs-12 col-sm-6 col-md-6 col-lg-4" id="widgetRow3"></div>
        </div>

        <div class="col-xs-12 col-sm-12 col-md-12" id="addWidget">
          <div class="widgetAdd">
            <span class="glyphicon glyphicon-plus"></span> Add widget
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="pages-wrapper">
    <div class="container-fluid">
      <div id="pages" class="col-xs-12 col-sm-12 col-md-12 col-lg-12"></div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/sogehige/SogeBot">GitHub</a> | <a href="https://github.com/sogehige/SogeBot/issues">Issues</a> | <a href="https://github.com/sogehige/SogeBot/blob/master/LICENSE">MIT License</a>
  </footer>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="./dist/jquery/js/jquery.min.js"></script>
  <!-- LoDash goodness -->
  <script src="./dist/lodash/js/lodash.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="./dist/bootstrap/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script type="text/javascript" src="./dist/js/zabuto_calendar.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="./dist/js/sortable.min.js"></script>
  <script type="text/javascript" src="./dist/bootstrap-toggle/js/bootstrap-toggle.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>

  <script>
    var socket = io();
    var loadedWidgets = []
    var loadedJS = []
    var loadedMenu = false
    var addingWidget = false

    var setStatus = function (id, status) {
      $("#" + id + "Status").removeClass()

      if (id === 'SOC' && status === 0) {
        $("[id$='Status']").removeClass()
        $("[id$='Status']").addClass('text-muted')
      }

      if (id === 'MOD') {
        $("#" + id + "Status").attr('title', 'Bot is' + (status ? ' ' : ' not ') + 'a MOD')
        $("#" + id + "Status").addClass('text-' + (status ? 'success' : 'danger'))
        return
      }

      switch (status) {
        case 0:
          $("#" + id + "Status").attr('title', id + ' disconnected')
          $("#" + id + "Status").addClass('text-danger')
          break;
        case 1:
          $("#" + id + "Status").attr('title', id + ' connecting')
          $("#" + id + "Status").addClass('text-warning')
          break;
        case 2:
          $("#" + id + "Status").attr('title', id + ' reconnecting')
          $("#" + id + "Status").addClass('text-warning')
        case 3:
          $("#" + id + "Status").attr('title', id + ' connected')
          $("#" + id + "Status").addClass('text-success')
          break;
      }
    }
    setInterval(function () { socket.emit('getConnectionStatus'); setStatus('SOC', socket.connected ? 3 : 0) }, 1000)
    socket.on('connectionStatus', function (data) {
      _.each(data, function (status, conn) {
        setStatus(conn, status)
      })
    })

    /* MENU */
    socket.on('menu', function(menu) {
      if (loadedMenu) return
      /* at first, clear all menu */
      $('#menu-*').empty()
      _.each(menu, function(obj) {
        if (obj.id !== 'dashboard') {
          $('#menu-' + obj.category).append('<li><a href="#" data-page="' + obj.id + '">' + obj.name + '</a></li>')
        }
      })
      loadedMenu = true

      $("#menu-main a").on('click', function(ev) {
        var page = ev.currentTarget.dataset.page
        var visibility = page !== 'dashboard' ? 'hidden' : 'visible'
        if (_.isUndefined(page)) return

        $("#menu-main a").removeClass('active')
        $(ev.currentTarget).addClass('active')

        $("#pages").empty()
        if (page !== 'dashboard') $("#pages").append($('<div id="P' + page + '">').load('pages/' + page + '.html'))

        $(".widgets").css('visibility', visibility)
        $("#addWidget").css('visibility', visibility)
      })
    })

    /* PAGES */
    // update top offset every second and on page resize
    $(window).resize(function() {
      $('.pages-wrapper').css('top', $(".widgets").offset().top + 20)
    })
    setInterval(function() {
      $('.pages-wrapper').css('top', $(".widgets").offset().top + 20)
    })

    /* WIDGETS */
    var deleteWidget = function(id) {
      $('#' + id).remove();
      socket.emit('deleteWidget', id)
      loadedWidgets.splice(loadedWidgets.indexOf(id), 1)
    }

    socket.on('widgets', function(widgets) {
      _.each(widgets, function(widget) {
        widget = widget.split(':')
        if (loadedWidgets.indexOf(widget[1]) === -1) {
          $("#widgetRow" + widget[0]).append($('<div id="' + widget[1] + '">').load('widgets/' + widget[1] + '.html'))
          loadedWidgets.push(widget[1])
        }
      })
    })

    // addWidget
    $("#addWidget").on('click', function(ev) {
      if (!addingWidget) {
        $(".widgets").append($('<div>').load('widgets/widget_create.html'))
        $("#addWidget").css('display', 'none')
        addingWidget = true
      }
    })

    /* STATS */
    setInterval(function() {
      socket.emit('getStats')
      socket.emit('getLatestStats')
    }, 1000)

    socket.on('latestStats', function (data) {
      if ($.isEmptyObject(data)) return

      var getPercentage = function (cur, orig) {
        if (orig === cur) return 0
        if (orig === 0) return cur * 100
        return Math.round((cur - orig) / orig * 1000) / 10
      }
      var setHtml = function (id, value) {
        if (value === 0) {
          $("#" + id).html('<span class="stats-mid"><span class="glyphicon glyphicon-triangle-right"></span> ' + Math.abs(value) + '%</span>')
        } else {
          $("#" + id).html('<span class="stats-' + (value < 0 ? 'down' : 'up') +
            ' text-' + (value < 0 ? 'danger' : 'success') +
            '"><span class="glyphicon glyphicon-triangle-' + (value < 0 ? 'bottom' : 'top') +
            '"></span> ' + Math.abs(value) + '%</span>')
        }
      }
      var uptime = $("#uptime").text()
      if (uptime !== '00:00:00' && uptime !== '--:--:--') {
        var maxViewers = getPercentage(parseInt($("#maxViewers").text(), 10), parseInt(data.maxViewers, 10))
        var totalChatMsgs = getPercentage(parseInt($("#totalChatMsgs").text(), 10), parseInt(data.chatMessages, 10))
        var newChtr = getPercentage(parseInt($("#newChtr").text(), 10), parseInt(data.newChatters, 10))
        var curFollowers = getPercentage(parseInt($("#curFollowers").text(), 10), parseInt(data.currentFollowers, 10))
        var curViews = getPercentage(parseInt($("#curViews").text(), 10), parseInt(data.currentViews, 10))
        var curHosts = getPercentage(parseInt($("#curHosts").text(), 10), parseInt(data.currentHosts, 10))

        setHtml('maxViewersChange', maxViewers)
        setHtml('totalChatMsgsChange', totalChatMsgs)
        setHtml('newChtrChange', newChtr)
        setHtml('curFollowersChange', curFollowers)
        setHtml('curViewsChange', curViews)
        setHtml('curHostsChange', curHosts)
      }
    })

    socket.on('stats', function(data) {
      var $curFollowers = $("#curFollowers")

      if (data.uptime === '' || data.uptime === '00:00:00') {
        data.currentViewers = 0
        data.maxViewers = 0
        data.chatMessages = 0
        data.newChatters = 0
        data.currentHosts = 0
      }

      $("#uptime").text(data.uptime !== '' ? data.uptime : '00:00:00')
      $(".curViewers").text(data.currentViewers)
      $("#curViews").text(data.currentViews)
      $("#curHosts").text(data.currentHosts)
      $("#maxViewers").text(data.maxViewers)
      $("#totalChatMsgs").text(data.chatMessages)
      $("#newChtr").text(data.newChatters)
      $("#curFollowers").text(data.currentFollowers)
      $("#title").text(data.status)
      $('#title').prop('title', data.status)
      $("#game").text(data.game)
      $('#game').prop('title', data.game)
    })

    var commons = {
      getDateString: function (d) {
        return ("0" + d.getDate()).slice(-2) + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" +
            d.getFullYear() + " " + ("0" + d.getHours()).slice(-2) + ":" + ("0" + d.getMinutes()).slice(-2);
      },
      minimize: function (el) {
        var toMinimize = el.dataset.id
        $(el).children().removeClass()
        if ($("#" + toMinimize).css('display') === 'none') {
          $(el).children().addClass('glyphicon glyphicon-resize-small text-muted')
          $("#" + toMinimize).css('display', 'block')
        } else {
          $(el).children().addClass('glyphicon glyphicon-resize-full text-muted')
          $("#" + toMinimize).css('display', 'none')
        }
      },
      configEditable: function(el, suffix) {
        var $inputGroup = $('#input_' + el.dataset.configId + '_group')
        var $input = $('#input_' + el.dataset.configId)
        $(el).css('display', 'none')
        $inputGroup.css('display', 'table')
        $input.focus()
        $input.val($(el).text().replace(suffix, ''))

        $input.off()
        $input.on('focusout', function() {
          var value = $input.val()
          var data = {}
          data[el.dataset.configId] = value
          $inputGroup.css('display', 'none')
          $(el).css('display', 'inline')
          $(el).text(value + suffix)
          socket.emit('saveConfiguration', data)
        })
      },
      confirm: function (el) {
        $(el).parent().children(".btn-confirm").css('display', 'inline-block')
        $(el).parent().children(".btn-remove").css('display', 'none')
      },
      unconfirm: function (el) {
        $(el).parent().children(".btn-confirm").css('display', 'none')
        $(el).parent().children(".btn-remove").css('display', 'inline-block')
      }
    }
  </script>
</body>

</html>