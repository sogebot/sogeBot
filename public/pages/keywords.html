<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  <ul class="nav nav-pills">
    <li>
      <span data-lang="keywords" class="title text-default"></span>
    </li>
    <li>
      <button class="btn btn-success plus-button" onclick="keywords.new()" style="padding: 9px 15px;">
        <i class="fa fa-plus" aria-hidden="true"></i>
      </button>
    </li>
    <li class="active">
      <a data-toggle="tab" href="#manage">Manage</a>
    </li>
    <li>
      <a data-toggle="tab" href="#responses">Responses</a>
    </li>
  </ul>
</div>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="manage">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <div class="widget">
        <table class="table table-striped table-responsive table-condensed">
          <tbody id="Keywords"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="responses">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <div class="widget">
        <table class="table table-striped table-responsive table-condensed">
          <tbody id="Responses">
            <tr>
              <td colspan="2">
                <kbd>!keyword add $keyword $response</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Success</span>
                <span class="custom-response" data-id="keywords.success.add"></span>
              </td>
              <td colspan="2">
                <kbd>!keyword add $keyword $response</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="keywords.failed.add"></span>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <kbd>!keyword remove !$keyword</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Success</span>
                <span class="custom-response" data-id="keywords.success.remove"></span>
              </td>
              <td colspan="2">
                <kbd>!keyword remove !$keyword</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="keywords.failed.remove"></span>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <kbd>!keyword list</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Populated $list</span>
                <span class="custom-response" data-id="keywords.success.list"></span>
              </td>
              <td colspan="2">
                <kbd>!keyword list</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Empty</span>
                <span class="custom-response" data-id="keywords.failed.list"></span>
              </td>
            </tr>
            <tr>
              <td>
                <kbd>!keyword toggle !$keyword</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Enabled</span>
                <span class="custom-response" data-id="keywords.success.enabled"></span>
              </td>
              <td colspan="2">
                <kbd>!keyword toggle !$keyword</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Disabled</span>
                <span class="custom-response" data-id="keywords.success.disabled"></span>
              </td>
              <td>
                <kbd>!keyword toggle !$keyword</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="keywords.failed.toggle"></span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  var keywords = {
    list: {},
    cancel: function () {
      $('#new-keyword').css('display', 'none')
      $('.new-confirm-btn').css('display', 'none')
      this.update(this.list)
    },
    new: function () {
      $('#new-keyword').css('display', 'table-row')
      $('.new-confirm-btn').css('display', 'block')
    },
    update: function (list) {
      this.list = list
      $("#Keywords").empty()
      $("#Keywords").append('<tr id="new-keyword" style="display:none">' +
        '<td style="vertical-align: top !important;min-width: 150px;"><span class="label label-default">New keyword</span>' +
        commons.editable({
          text: '',
          id: '_new!',
          fnc: 'commons.stub'
        }) + '</td>' +
        '<td style="vertical-align: top !important;"><span class="label label-primary">Response</span> ' +
        commons.editable({
          text: '&nbsp;',
          id: '_new!',
          fnc: 'commons.stub'
        }) +
        '<div class="btn-group pull-right">' +
        '<button class="save-button btn btn-success new-confirm-btn" style="display:none" onclick="keywords.create(event)">SAVE</button>' +
        '<button class="btn btn-warning new-confirm-btn" style="display:none" onclick="keywords.cancel()">CANCEL</button>' +
        '</div>' +
        '</td>' +
        '</tr>');
      _.each(list, function (item, index) {
        $("#Keywords").append('<tr class="page-data-row">' +
          '<td style="vertical-align: top !important;min-width: 150px;"><span class="label label-default">Keyword</span>' +
          commons.editable({
            text: item.keyword,
            id: item.keyword,
            fnc: 'keywords.editName'
          }) + '</td>' +
          '<td style="vertical-align: top !important;"><span class="label label-primary">Response</span> ' +
          '<span style="cursor: pointer;" class="label label-' + (item.enabled ? "success" : "danger") +
          '" data-id="' + item.keyword + '" onclick="keywords.toggle(this)">' + (item.enabled ? "enabled" :
            "disabled") + '</span>' +
          '<span style="cursor: not-allowed; float:right; padding: 4px;" class="label label-danger btn-remove" data-id="' +
          item.keyword + '"  onclick="commons.confirm(this)">delete</span>' +
          '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-warning btn-confirm" onclick="commons.unconfirm(this)">cancel</span>' +
          '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-success btn-confirm" onclick="keywords.delete(this)" data-id="' +
          item.keyword + '">confirm</span>' +
          commons.editable({
            text: item.response,
            id: item.keyword,
            fnc: 'keywords.edit'
          }) +
          '</td>' +
          '</tr>')
      })
    },
    editName: function (id, value) {
      socket.emit('keywords.editKeyword', {
        id: id,
        value: value
      })
    },
    edit: function (id, value) {
      socket.emit('keywords.editResponse', {
        id: id,
        value: value
      })
    },
    delete: function (el) {
      socket.emit('keywords.remove', el.dataset.id)
    },
    toggle: function (el) {
      socket.emit('keywords.toggle', el.dataset.id)
    },
    create: function (event) {
      event.preventDefault()
      var inputs = $('[data-id="_new!"]')
      var data = {
        keyword: $(inputs[0]).text().replace('!', ''),
        response: commons.cleanResponseText($(inputs[1]).html())
      }
      socket.emit('keywords.add', `${data.keyword} ${data.response}`)
      $('.new-confirm-btn').css('display', 'none')
    },
    responses: function () {
      socket.emit('responses.get', 'keywords', function (data) {
        _.each(data, function (value, key) {
          var filters = ['global']

          if (key === 'success.add' || key === 'failed.add') {
            filters.push('keyword')
            filters.push('response')
          }

          if (key === 'success.remove' || key === 'failed.remove' || key === 'success.enabled' ||
            key === 'success.disabled' || key === 'failed.toggle') {
            filters.push('keyword')
          }
          if (key === 'success.list') {
            filters.push('list')
          }

          key = 'keywords.' + key
          $('[data-id="' + key + '"]').html(commons.editable({
            text: value,
            id: key,
            fnc: 'commons.setResponse',
            filters: filters
          }))
        })
      })
    }
  }

  keywords.responses()
  keywords.update([])

  socket.emit('keywords.send')
  socket.on('keywords', function (list) {
    keywords.update(list)
  })

  window.keywords = keywords

</script>
