<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  <ul class="nav nav-pills">
    <li>
      <span data-lang="cooldowns" class="title text-default"></span>
    </li>
    <li>
      <button class="btn btn-success plus-button" onclick="cooldown.new()" style="padding: 9px 15px;">
        <i class="fa fa-plus" aria-hidden="true"></i>
      </button>
    </li>
    <li class="active">
      <a data-toggle="tab" href="#manage">Manage</a>
    </li>
    <li>
      <a data-toggle="tab" href="#responses">Responses</a>
    </li>
  </ul>
</div>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="manage">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <div class="widget">
        <table class="table table-striped table-responsive table-condensed">
          <tbody id="Cooldowns">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="responses">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <div class="widget">
        <table class="table table-striped table-responsive table-condensed">
          <tbody id="Responses">
            <tr>
              <td colspan="2">
                <kbd>!cooldown $command $type $seconds $quiet</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Set</span>
                <span class="custom-response" data-id="cooldown.success.set"></span>
              </td>
              <td colspan="2">
                <kbd>!cooldown $command $type $seconds $quiet</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Unset (0s)</span>
                <span class="custom-response" data-id="cooldown.success.unset"></span>
              </td>
            </tr>
            <tr>
              <td>
                <kbd>!cooldown toggle moderators $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Enabled</span>
                <span class="custom-response" data-id="cooldown.toggle.moderator.enabled"></span>
              </td>
              <td colspan="2">
                <kbd>!cooldown toggle moderators $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Disabled</span>
                <span class="custom-response" data-id="cooldown.toggle.moderator.disabled"></span>
              </td>
              <td>
                <kbd>!cooldown toggle moderators $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="cooldown.toggle.moderator.failed"></span>
              </td>
            </tr>
            <tr>
              <td>
                <kbd>!cooldown toggle owners $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Enabled</span>
                <span class="custom-response" data-id="cooldown.toggle.owner.enabled"></span>
              </td>
              <td colspan="2">
                <kbd>!cooldown toggle owners $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Disabled</span>
                <span class="custom-response" data-id="cooldown.toggle.owner.disabled"></span>
              </td>
              <td>
                <kbd>!cooldown toggle owners $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="cooldown.toggle.owner.failed"></span>
              </td>
            </tr>
            <tr>
              <td>
                <kbd>!cooldown toggle enabled $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Enabled</span>
                <span class="custom-response" data-id="cooldown.success.enabled"></span>
              </td>
              <td colspan="2">
                <kbd>!cooldown toggle enabled $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Disabled</span>
                <span class="custom-response" data-id="cooldown.success.disabled"></span>
              </td>
              <td>
                <kbd>!cooldown toggle enabled $command</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="cooldown.failed.toggle"></span>
              </td>
            </tr>
            <tr>
              <td colspan="4">
                <span class="label label-trigger">Cooldown triggered</span>
                <span class="label label-primary">Response</span>
                <span class="custom-response" data-id="cooldown.failed.cooldown"></span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  var cooldown = {
    list: {},
    cancel: function () {
      $('#new-cooldown').css('display', 'none')
      $('.new-confirm-btn').css('display', 'none')
      this.update(this.list)
    },
    new: function () {
      $('#new-cooldown').css('display', 'table-row')
      $('.new-confirm-btn').css('display', 'block')
    },
    toggleBtn: function () {
      var $toggle = $("#quietToggle")
      if ($toggle.text() === translations['cooldown-quiet-toggle-no']) {
        $toggle.text(translations['cooldown-quiet-toggle-yes'])
      } else $toggle.text(translations['cooldown-quiet-toggle-no'])
    },
    update: function (list) {
      this.list = list
      $("#Cooldowns").empty()
      $("#Cooldowns").append('<tr id="new-cooldown" style="display:none">' +
          '<td style="vertical-align: top !important;min-width: 150px;"><span class="label label-default">New !command/keyword</span>' + commons.editable({ text: '', id: '_new!', fnc: 'commons.stub' }) + '</td>' +
          '<td style="vertical-align: top !important;"><span class="label label-primary">Cooldown</span> ' +
              commons.editable({ text: '&nbsp;', id: '_new!', fnc: 'commons.stub' }) +
          '<div class="btn-group pull-right">' +
            '<button class="save-button btn btn-success new-confirm-btn" style="display:none" onclick="cooldown.create(event)">SAVE</button>' +
            '<button class="btn btn-warning new-confirm-btn" style="display:none" onclick="cooldown.cancel()">CANCEL</button>' +
          '</div>' +
          '</td>' +
          '</tr>');
      for (let item of list) {
        $("#Cooldowns").append('<tr class="page-data-row">' +
            '<td style="vertical-align: top !important;min-width: 150px;"><span class="label label-default">' + (item.key.startsWith('!') ? 'Command' : "Keyword") + '</span>' + commons.editable({ text: item.key, id: item.key, fnc: 'cooldown.editName', options: { type: item.type }}) + '</td>' +
            '<td style="vertical-align: top !important;"><span class="label label-primary">Cooldown</span> ' +
              '<span style="cursor: pointer;" class="label label-' + (item.type) + '" " data-type="' + item.type + '" data-id="' + item.key + '" onclick="cooldown.toggleType(this)">type:' + translations[item.type] + '</span> ' +
              '<span style="cursor: pointer;" class="label label-' + (item.quiet ? "danger": "success") + '" " data-type="' + item.type + '" data-id="' + item.key + '" onclick="cooldown.toggleNotify(this)">notify:' + translations[item.quiet ? 'cooldown-quiet-toggle-yes' : 'cooldown-quiet-toggle-no'] + '</span> ' +
              '<span style="cursor: pointer;" class="label label-' + (item.moderator ? "success": "danger") + '" data-type="' + item.type + '" data-id="' + item.key + '" onclick="cooldown.toggleModerators(this)">moderators:' + translations[item.moderator ? "comply": "omit"] + '</span> ' +
              '<span style="cursor: pointer;" class="label label-' + (item.owner ? "success": "danger") + '" data-type="' + item.type + '" data-id="' + item.key + '" onclick="cooldown.toggleOwners(this)">owners:' + translations[item.owner ? "comply": "omit"] + '</span> ' +
              '<span style="cursor: pointer;" class="label label-' + (item.enabled ? "success": "danger") + '" data-type="' + item.type + '" data-id="' + item.key + '" onclick="cooldown.toggle(this)">' + (item.enabled ? "enabled": "disabled") + '</span>' +
              '<span style="cursor: not-allowed; float:right; padding: 4px;" class="label label-danger btn-remove" data-type="' + item.type + '" data-id="' + item.key + '"  onclick="commons.confirm(this)">delete</span>' +
              '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-warning btn-confirm" onclick="commons.unconfirm(this)">cancel</span>' +
              '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-success btn-confirm" onclick="cooldown.delete(this)" data-type="' + item.type + '" data-id="' + item.key + '">confirm</span>' +
              commons.editable({ text: item.miliseconds / 1000, id: item.key, fnc: 'cooldown.edit', options: { type: item.type } }) +
            '</td>' +
          '</tr>');
      }
    },
    edit: function (id, value, options) {
      socket.emit('cooldown.set', `${id} ${options.type} ${value}`)
    },
    editName: function (id, value, options) {
      socket.emit('cooldown.editName', {id: id, value: value, type: options.type})
    },
    toggle: function (el) {
      socket.emit('cooldown.toggleEnabled', `${el.dataset.id} ${el.dataset.type}`)
    },
    toggleModerators: function (el) {
      socket.emit('cooldown.toggleModerators', `${el.dataset.id} ${el.dataset.type}`)
    },
    toggleOwners: function (el) {
      socket.emit('cooldown.toggleOwners', `${el.dataset.id} ${el.dataset.type}`)
    },
    toggleNotify: function (el) {
      socket.emit('cooldown.toggleNotify', `${el.dataset.id} ${el.dataset.type}` )
    },
    toggleType: function (el) {
      socket.emit('cooldown.toggleType', `${el.dataset.id} ${el.dataset.type}` )
    },
    delete: function (el) {
      socket.emit('cooldown.set', `${el.dataset.id} ${el.dataset.type} 0`)
    },
    create: function (event) {
      event.preventDefault()
      var inputs = $('[data-id="_new!"]')
      var data = {
        command: $(inputs[0]).text(),
        type: 'global',
        quiet: true,
        seconds: commons.cleanResponseText($(inputs[1]).html())
      }
      socket.emit('cooldown.set', `${data.command} ${data.type} ${data.seconds} ${data.quiet}`)
    },
    responses: function () {
      socket.emit('responses.get', 'cooldown', function (data) {
        _.each(data, function (value, key) {
          var filters = ['global']

          // add command and reponse filters
          filters.push('command')
          if (key === 'success.set' || key === 'success.unset') {
            filters.push('type')
            filters.push('seconds')
            filters.push('quiet')
          }

          if (key === 'failed.cooldown') {
            filters.push('seconds')
          }
          key = 'cooldown.' + key
          $('[data-id="' + key + '"]').html(commons.editable({ text: value, id: key, fnc: 'commons.setResponse', filters: filters }))
        })
      })
    }
  }

  cooldown.responses()
  cooldown.update([])

  socket.emit('cooldown.send');
  socket.on('cooldown', function(list) {
    cooldown.update(list)
  });

  </script>
