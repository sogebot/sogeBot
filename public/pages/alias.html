<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  <ul class="nav nav-pills">
    <li>
      <span data-lang="aliases" class="title text-default"></span>
    </li>
    <li>
      <button class="btn btn-success plus-button" onclick="alias.new()" style="padding: 9px 15px;">
        <i class="fa fa-plus" aria-hidden="true"></i>
      </button>
    </li>
    <li class="active">
      <a data-toggle="tab" href="#manage">Manage</a>
    </li>
    <li>
      <a data-toggle="tab" href="#responses">Responses</a>
    </li>
  </ul>
</div>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="manage">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <div class="widget">
        <table class="table table-striped table-responsive table-condensed">
          <tbody id="Alias"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="responses">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      <div class="widget">
        <table class="table table-striped table-responsive table-condensed">
          <tbody id="Responses">
            <tr>
              <td colspan="2">
                <kbd>!alias add !$command !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Success</span>
                <span class="custom-response" data-id="alias.success.add"></span>
              </td>
              <td colspan="2">
                <kbd>!alias add !$command !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="alias.failed.add"></span>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <kbd>!alias remove !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Success</span>
                <span class="custom-response" data-id="alias.success.remove"></span>
              </td>
              <td colspan="2">
                <kbd>!alias remove !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="alias.failed.remove"></span>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <kbd>!alias list</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Populated $list</span>
                <span class="custom-response" data-id="alias.success.list"></span>
              </td>
              <td colspan="2">
                <kbd>!alias list</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Empty</span>
                <span class="custom-response" data-id="alias.failed.list"></span>
              </td>
            </tr>
            <tr>
              <td>
                <kbd>!alias toggle !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Enabled</span>
                <span class="custom-response" data-id="alias.success.enabled"></span>
              </td>
              <td colspan="2">
                <kbd>!alias toggle !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Disabled</span>
                <span class="custom-response" data-id="alias.success.disabled"></span>
              </td>
              <td>
                <kbd>!alias toggle !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="alias.failed.toggle"></span>
              </td>
            </tr>
            <tr>
              <td>
                <kbd>!alias toggle-visibility !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-success">Visible</span>
                <span class="custom-response" data-id="alias.success.visible"></span>
              </td>
              <td colspan="2">
                <kbd>!alias toggle-visibility !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-warning">Invisible</span>
                <span class="custom-response" data-id="alias.success.invisible"></span>
              </td>
              <td>
                <kbd>!alias toggle-visibility !$alias</kbd>
                <span class="label label-primary">Response</span>
                <span class="label label-danger">Failure</span>
                <span class="custom-response" data-id="alias.failed.visible"></span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

  <script>
    var alias = {
      list: {},
      cancel: function () {
        $('#new-alias').css('display', 'none')
        $('.new-confirm-btn').css('display', 'none')
        this.update(this.list)
      },
      new: function () {
        $('#new-alias').css('display', 'table-row')
        $('.new-confirm-btn').css('display', 'block')

        $('#new-alias [contenteditable=true]:first').off()
        $('#new-alias [contenteditable=true]:first').keyup(function (ev) {
          var alias = $(ev.target).text().trim()
          if (!alias.startsWith('!')) alias = '!' + alias
          socket.emit('parser.isRegistered', {
            emit: 'alias.check',
            command: alias
          })
        })
      },
      update: function (list) {
        this.list = list
        $("#Alias").empty()
        $("#Alias").append('<tr id="new-alias" style="display:none">' +
          '<td style="vertical-align: top !important;min-width: 150px;"><span class="label label-default">New alias</span> <span class="status label label-warning">available</span>' +
          commons.editable({
            text: '',
            id: '_new!',
            fnc: 'commons.stub'
          }) + '</td>' +
          '<td style="vertical-align: top !important;"><span class="label label-primary">Command</span> ' +
          commons.editable({
            text: '&nbsp;',
            id: '_new!',
            fnc: 'commons.stub'
          }) +
          '<div class="btn-group pull-right">' +
          '<button class="save-button btn btn-success new-confirm-btn" style="display:none" onclick="alias.create(event)">SAVE</button>' +
          '<button class="btn btn-warning new-confirm-btn" style="display:none" onclick="alias.cancel()">CANCEL</button>' +
          '</div>' +
          '</td>' +
          '</tr>');
        _.each(list, function (item, index) {
          $("#Alias").append('<tr class="page-data-row">' +
            '<td style="vertical-align: top !important;min-width: 150px;"><span class="label label-default">Alias</span>' +
            commons.editable({
              text: '!' + item.alias,
              id: item.alias,
              fnc: 'alias.editName'
            }) + '</td>' +
            '<td style="vertical-align: top !important;"><span class="label label-primary">Command</span> ' +
            '<span style="cursor: pointer;" class="label label-' + (item.visible ? "success" : "danger") +
            '" " data-id="' + item.alias + '" onclick="alias.toggleVisibility(this)">' + (item.visible ?
              "visible" : "hidden") + '</span> ' +
            '<span style="cursor: pointer;" class="label label-' + (item.enabled ? "success" : "danger") +
            '" data-id="' + item.alias + '" onclick="alias.toggle(this)">' + (item.enabled ? "enabled" :
              "disabled") + '</span>' +
            '<span style="cursor: not-allowed; float:right; padding: 4px;" class="label label-danger btn-remove" data-id="' +
            item.alias + '"  onclick="commons.confirm(this)">delete</span>' +
            '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-warning btn-confirm" onclick="commons.unconfirm(this)">cancel</span>' +
            '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-success btn-confirm" onclick="alias.delete(this)" data-id="' +
            item.alias + '">confirm</span>' +
            commons.editable({
              text: '!' + item.command,
              id: item.alias,
              fnc: 'alias.edit'
            }) +
            '</td>' +
            '</tr>');
        })
      },
      editName: function (id, value) {
        socket.emit('alias.editAlias', {
          id: id,
          value: value
        })
      },
      edit: function (id, value) {
        socket.emit('alias.editCommand', {
          id: id,
          value: value
        })
      },
      delete: function (el) {
        socket.emit('alias.remove', _.isObject(el) ? `!${el.dataset.id}` : `!${el}`)
      },
      toggle: function (el) {
        socket.emit('alias.toggle', `!${el.dataset.id}`)
      },
      toggleVisibility: function (el) {
        socket.emit('alias.visible', `!${el.dataset.id}`)
      },
      create: function (event) {
        event.preventDefault()
        var inputs = $('[data-id="_new!"]')
        var data = {
          alias: $(inputs[0]).text().replace('!', ''),
          command: commons.cleanResponseText($(inputs[1]).html().replace('!', ''))
        }
        socket.emit('alias.add', `!${data.command} !${data.alias}`)
        $('.new-confirm-btn').css('display', 'none')
      },
      responses: function (id) {
        id = id || null
        socket.emit('responses.get', 'alias', function (data) {
          _.each(data, function (value, key) {
            if (!_.isNil(id) && 'alias.' + key !== id) return true // continue if we want only specific id
            var filters = ['global']

            // add command and reponse filters
            if (key === 'success.add' || key === 'failed.add') {
              filters.push('command')
              filters.push('alias')
            }
            if (key === 'success.remove' || key === 'failed.remove' || key === 'success.enabled' ||
              key === 'success.disabled' || key === 'failed.toggle' || key === 'success.visible' ||
              key === 'success.invisible' || key === 'failed.visible') {
              filters.push('alias')
            }
            if (key === 'success.list') {
              filters.push('list')
            }
            key = 'alias.' + key
            $('[data-id="' + key + '"]').html(commons.editable({
              text: value,
              id: key,
              fnc: 'commons.setResponse',
              filters: filters
            }))
          })
        })
      }
    }

    alias.responses()
    alias.update([])

    socket.emit('alias.send');

    socket.on('alias', function (list) {
      alias.update(list)
    })

    socket.on('alias.check', function (data) {
      if (data.isRegistered) {
        $('.status').removeClass().addClass('label label-danger status')
        $('.save-button').prop('disabled', true)
      } else {
        $('.status').removeClass().addClass('label label-success status')
        $('.save-button').prop('disabled', false)
      }
    })

  </script>
