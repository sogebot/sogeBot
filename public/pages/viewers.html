<!-- Viewers Modal Dlg -->
<div class="modal" id="viewersDlg" role="dialog" aria-labelledby="new_version_dlg">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">User <strong id="viewers_username"></strong></h4>
      </div>
      <div class="modal-body">
        <div class="dialog-group">
          <div class="input-group flex-nowrap">
            <button class="btn btn-success w-100" id="viewers_follower_toggle">Follower</button>
            <button class="btn btn-success w-100" id="viewers_subscriber_toggle">Subscriber</button>
            <button class="btn btn-success w-100" id="viewers_regular_toggle">Regular</button>
          </div>
        </div>
        <div class="dialog-group">
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="last-seen"></span>
            </div>
            <input type="text" class="form-control datetimepicker-input" id="viewers_last_seen" data-toggle="datetimepicker" data-target="#viewers_last_seen"/>
          </div>
          <div class="input-group mt-1">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="followed-since"></span>
            </div>
            <input type="text" class="form-control datetimepicker-input" id="viewers_followed_at" data-toggle="datetimepicker" data-target="#viewers_followed_at"/>
          </div>
          <div class="input-group mt-1">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="subscribed-since"></span>
            </div>
            <input type="text" class="form-control datetimepicker-input" id="viewers_subscribed_at" data-toggle="datetimepicker" data-target="#viewers_subscribed_at"/>
          </div>
        </div>

        <div class="dialog-group">
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="watched-time"></span>
            </div>
            <input type="text" class="form-control" id="viewers_watched"/>
            <div class="input-group-append">
              <span class="input-group-text">h</span>
            </div>
          </div>
          <div class="input-group mt-1 points-enabled">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="points"></span>
            </div>
            <input type="text" class="form-control" id="viewers_points"/>
          </div>
          <div class="input-group mt-1">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="messages"></span>
            </div>
            <input type="text" class="form-control" id="viewers_messages"/>
          </div>
        </div>

        <div class="dialog-group">
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" data-lang="tier"></span>
            </div>
            <input type="text" class="form-control" id="viewers_tier"/>
          </div>
        </div>

        <div class="dialog-group">
          <div class="card">
            <div class="card-header" style="display: flex; padding: 0;">
              <div data-lang="bits" style="line-height: 1.9rem; padding-left: 1rem;"></div>
              <button class="ml-auto btn btn-sm btn-primary" id="new_bits"><i class="fas fa-plus" aria-hidden="true"></i></button>
            </div>
            <div class="card-body p-0">
              <table class="table table-sm m-0 table-hover">
                <tbody id="viewers_bits"></tbody>
              </table>
            </div>
          </div>

          <div class="card mt-2">
            <div class="card-header" style="display: flex; padding: 0;">
              <div data-lang="tips" style="line-height: 1.9rem; padding-left: 1rem;"></div>
              <button class="ml-auto btn btn-sm btn-primary" id="new_tips"><i class="fas fa-plus" aria-hidden="true"></i></button>
            </div>
            <div class="card-body p-0">
              <table class="table table-sm m-0 table-hover">
                <tbody id="viewers_tips"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger mr-auto" onclick="viewers.delete(this)">
          <i data-lang="delete"></i>
        </button>
        <button type="button" class="btn btn-default" data-dismiss="modal">
          <i data-lang="close"></i>
        </button>
        <button type="button" class="btn btn-primary" onclick="viewers.save(this)">
          <i data-lang="save-changes"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs">
  <li class="nav-item">
    <span data-lang="menu.viewers" class="title text-default"></span>
  </li>

  <li class="nav-item">
    <a class="nav-link active" data-toggle="tab" href="#manage" data-lang="manage"></a>
  </li>

  <li class="nav-item">
    <a class="nav-link" data-toggle="tab" href="#ignorelist" data-lang="ignorelist"></a>
  </li>

  <li class="nav-item ml-auto" id="users-search" style="position: relative; top: -.2rem">
    <div class="btn-group">
        <input type="text" class="form-control form-search" style="margin:0 4px; padding: 8px 5px;" placeholder="Search by username" id="viewersSearch" onkeyup="viewers.updateSearch()">
      <div class="dropdown">
        <button class="btn btn-danger dropdown-toggle" type="button" style="margin:0; padding: 8px 5px;" data-toggle="dropdown">
          <span data-lang="viewers-reset-attributes"></span>
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" style="font-variant: small-caps">
          <li>
            <button class="dropdown-item" id="reset-points-of-all-users" data-lang="viewers-points-of-all-users"></button>
          </li>
          <li>
            <button class="dropdown-item" id="reset-messages-of-all-users" data-lang="viewers-messages-of-all-users"></button>
          </li>
          <li>
            <button class="dropdown-item" id="reset-watchtime-of-all-users" data-lang="viewers-watchtime-of-all-users"></button>
          </li>
        </ul>
      </div>
      <ul class="paging"></ul>
    </div>
  </li>
</ul>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="manage">
    <div class="widget">
      <table class="table table-striped table-sm table-hover">
        <thead>
          <tr>
            <th class="sortable" onclick="viewers.sort(this)" data-sort="username">
              <span data-lang="username"></span>
              <i class="fas fa-sort-up" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="time.message">
              <span data-lang="last-seen"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="time.watched">
              <span data-lang="watched-time"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="time.follow">
              <span data-lang="followed-since"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="time.subscribed_at">
              <span data-lang="subscribed-since"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th id="viewers-points" class="sortable text-center" onclick="viewers.sort(this)" data-sort="points">
              <span data-lang="points"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="stats.messages">
              <span data-lang="messages"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="stats.tips">
              <span data-lang="tips"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="stats.bits">
              <span data-lang="bits"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="sortable text-center" onclick="viewers.sort(this)" data-sort="stats.tier">
              <span data-lang="tier"></span>
              <i class="fa" aria-hidden="true"></i>
            </th>
            <th class="text-center" style="width: 1px; cursor: pointer; user-select: none">
              <span class="alert alert-secondary" style="padding: 0 1.25rem" onclick="viewers.toggle(this)" data-toggle="subscriber">SUBSCRIBER</span>
            </th>
            <th class="text-center" style="width: 1px; cursor: pointer; user-select: none">
              <span class="alert alert-secondary" style="padding: 0 1.25rem" onclick="viewers.toggle(this)" data-toggle="follower">FOLLOWER</span>
            </th>
            <th class="text-center" style="width: 1px; cursor: pointer; user-select: none">
              <span class="alert alert-secondary" style="padding: 0 1.25rem" onclick="viewers.toggle(this)" data-toggle="regular">REGULAR</span>
            </th>
            <th class="text-center" style="width: 1px; cursor: pointer; user-select: none">
              <span class="alert alert-secondary" style="padding: 0 1.25rem" onclick="viewers.toggle(this)" data-toggle="active">ACTIVE</span>
            </th>
          </tr>
        </thead>
        <tbody id="Users">
        </tbody>
      </table>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="ignorelist">
    <div class="row settings">
      <div class="col">
        <strong data-lang="ignorelist"></strong>
        <small data-lang="one-record-per-line"></small>
      </div>
      <div class="w-100"></div>
      <div class="col">
        <textarea class="form-control" rows="10" id="ignorelist-textarea"></textarea>
        <button class="btn btn-lg btn-outline-info float-right" id="ignorelist-submit">Save changes</button>
        <div class="alert alert-info d-none" role="alert" id="ignorelist-alert-info"><i class="fas fa-spinner fa-pulse fa-fw" ></i>Saving changes</div>
        <div class="alert alert-danger d-none" role="alert" id="ignorelist-alert-danger">Something went wrong!</div>
        <div class="alert alert-success d-none" role="alert" id="ignorelist-alert-success">Saved OK!</div>
      </div>
    </div>
  </div>
</div>
<script>
  var datepickeropts = {
    icons: {
      time: "far fa-clock",
      date: "far fa-calendar-alt",
      up: "fas fa-angle-up",
      down: "fas fa-angle-down"
    },
    format: 'HH:mm:ss, YYYY-MM-DD' // 21:21:37, 2016-07-09
  }

  var pagination = 1
  var viewers = {
    socket: null,
    sortBy: 'username',
    sortType: 'up',
    toSearch: '',
    list: {},
    toggle: function (el) {
      const type = $(el).data('toggle')
      if ($(el).hasClass('alert-secondary')) {
        $(el).removeClass('alert-secondary').addClass('alert-success')
      } else if ($(el).hasClass('alert-danger')) {
        $(el).removeClass('alert-danger').addClass('alert-secondary')
      } else {
        $(el).removeClass('alert-success').addClass('alert-danger')
      }
      viewers.update(viewers.paging())
    },
    save: function (el) {
      let user = {
        username: $('#viewers_username').text(),
        is: {
          follower: $('#viewers_follower_toggle').hasClass('btn-success'),
          subscriber: $('#viewers_subscriber_toggle').hasClass('btn-success'),
          regular: $('#viewers_regular_toggle').hasClass('btn-success')
        },
        time: {
          message: $('#viewers_last_seen').val().trim().length === 0 ? null : parseInt(moment($('#viewers_last_seen').val(), "HH:mm:ss YYYY-MM-DD").format('x'), 10),
          follow: $('#viewers_followed_at').val().trim().length === 0 ? null : parseInt(moment($('#viewers_followed_at').val(), "HH:mm:ss YYYY-MM-DD").format('x'), 10),
          subscribed_at: $('#viewers_subscribed_at').val().trim().length === 0 ? null : parseInt(moment($('#viewers_subscribed_at').val(), "HH:mm:ss YYYY-MM-DD").format('x'), 10),
          watched: $('#viewers_watched').val() * 1000 * 60 * 60
        },
        points: !systems.points || $('#viewers_points').val().length === 0 ? 0 : $('#viewers_points').val(),
        stats: {
          messages: $('#viewers_messages').val().length === 0 ? 0 : $('#viewers_messages').val(),
          tier: $('#viewers_tier').val().length === 0 ? null : $('#viewers_tier').val()
        }
      }
      if (!systems.points) delete user.points
      // toggle save button to btn-info and disable\
      $(el).toggleClass('btn-primary btn-info').attr('disabled', 'disabled').html('<i class="fas fa-circle-notch fa-spin"></i> ' + commons.translate('saving'))
      viewers.socket.emit('save', user, (err) => {
        if (err) return console.error(err)
        $(el).toggleClass('btn-primary btn-info').removeAttr('disabled').html(commons.translate('save-changes'))
        $('#viewersDlg').modal('hide')
        socket.emit('getViewers')
      })
    },
    update: function (list) {
      $("#Users").empty()
      _.each(list, function (item, index) {
        item.points = _.isUndefined(item.points) ? 0 : item.points
        item.time = _.isNil(item.time) ? {} : item.time
        let followed_at = viewers.styleFollowTime(_.get(item, 'time.follow', 0))
        followed_at = item.is.follower ? followed_at : `<span class="text-muted">${followed_at}</span>`
        let subscribed_at = viewers.styleFollowTime(_.get(item, 'time.subscribed_at', 0))
        subscribed_at = item.is.follower ? subscribed_at : `<span class="text-muted">${subscribed_at}</span>`
        let lastseen = viewers.styleFollowTime(_.get(item, 'time.message', 0))
        $("#Users").append(`
          <tr data-username="${item.username}" data-toggle="modal" data-target="#viewersDlg">
            <td>${item.username}</td>
            <td class="text-center" data-value='${_.get(item, 'time.message', 0)}'>${lastseen}</td>
            <td class="text-center" data-value='${_.get(item, 'time.watched', 0)}'>${viewers.styleWatched(item.time.watched)}h</td>
            <td class="text-center" data-value='${!item.is.follower ? 0 : _.get(item, 'time.follow', 0)}'>${followed_at}</td>
            <td class="text-center" data-value='${!item.is.subscriber ? 0 : _.get(item, 'time.subscribed_at', 0)}'>${subscribed_at}</td>
            ${systems.points ? `<td class="text-center" data-value='${_.get(item, 'points', 0)}'>${_.get(item, 'points', 0)}</td>` : ``}
            <td class="text-center" data-value='${_.get(item, 'stats.messages', 0)}'>${_.get(item, 'stats.messages', 0)}</td>
            <td class="text-center" data-value='${_.get(item, 'stats.tips', 0)}'>${_.get(item, 'stats.tips', 0).toFixed(2)}${item.custom.currency}</td>
            <td class="text-center" data-value='${_.get(item, 'stats.bits', 0)}'>${_.get(item, 'stats.bits', 0)}</td>
            <td class="text-center" data-value='${_.get(item, 'stats.tier', 0)}'>${_.isNil(_.get(item, 'stats.tier', 0)) || parseInt(_.get(item, 'stats.tier', 0), 10) === 0 ? '<hr>' : _.get(item, 'stats.tier', 0)}</td>
            <td class="text-center">
              <span class="alert alert-${item.is.subscriber ? 'success' : 'danger'}" style="padding: 0 1.25rem">SUBSCRIBER</span>
            </td>
            <td class="text-center">
              <span class="alert alert-${item.is.follower ? 'success' : 'danger'}" style="padding: 0 1.25rem">FOLLOWER</span>
            </td>
            <td class="text-center">
              <span class="alert alert-${item.is.regular ? 'success' : 'danger'}" style="padding: 0 1.25rem">REGULAR</span>
            </td>
            <td class="text-center">
              <span class="alert alert-${item.is.online ? 'success' : 'danger'}" style="padding: 0 1.25rem">ACTIVE</span>
            </td>
            <td>
          </tr>
        `)
        if (!systems.points) {
          $(".points-enabled").remove()
          $("#viewers-points-data").remove()
          $("#viewers-points").remove()
        }
      })
    },
    getDateString: function (timestamp) {
      if (_.isNil(timestamp) || timestamp === 0) return '<hr>'
      return moment(timestamp).format('HH:mm:ss, YYYY-MM-DD')
    },
    styleFollowTime: function (timestamp) {
      if (_.isNil(timestamp) || parseInt(timestamp, 10) === 0) return '<hr>'
      return moment(parseInt(timestamp, 10)).format('HH:mm:ss, YYYY-MM-DD')
    },
    styleWatched: function (timestamp) {
      if (_.isNil(timestamp)) timestamp = 0
      return (timestamp / 1000 / 60 / 60).toFixed(1)
    },
    delete: function (el) {
      viewers.socket.emit('delete', $('#viewers_username').text(), () => {
        $('#viewersDlg').modal('hide')
        socket.emit('getViewers')
      })
    },
    sort: function (el) {
      $('table tr th i').removeClass()

      if (viewers.sortBy === el.dataset.sort) {
        viewers.sortType = viewers.sortType === 'up' ? 'down' : 'up'
      } else {
        viewers.sortType = 'down'
        if (el.dataset.sort === 'username') viewers.sortType = 'up'
      }
      viewers.sortBy = el.dataset.sort
      $(el).children('i').addClass('fas fa-sort-' + viewers.sortType)
      viewers.update(viewers.paging(viewers.list))
    },
    pagination: function (i) {
      pagination = i
      viewers.update(viewers.paging(viewers.list))
    },
    search: function (list) {
      return _.filter(list, function (o) {
        if (viewers.search.length === 0) return true
        return o.username.toLowerCase().indexOf(viewers.toSearch.toLowerCase()) >= 0;
      })
    },
    updateSearch: function () {
      viewers.toSearch = $('#viewersSearch').val()
      pagination = 1
      viewers.update(viewers.paging())
    },
    paging: function () {
      var list = _.sortBy(_.filter(viewers.search(viewers.list), (o) => {
        const subscriberFilter = ($('[data-toggle="subscriber"]').hasClass('alert-success') && o.is.subscriber)
          || ($('[data-toggle="subscriber"]').hasClass('alert-danger') && !o.is.subscriber)
          || $('[data-toggle="subscriber"]').hasClass('alert-secondary')
        const followerFilter = ($('[data-toggle="follower"]').hasClass('alert-success') && o.is.follower)
          || ($('[data-toggle="follower"]').hasClass('alert-danger') && !o.is.follower)
          || $('[data-toggle="follower"]').hasClass('alert-secondary')
        const regularFilter = ($('[data-toggle="regular"]').hasClass('alert-success') && o.is.regular)
          || ($('[data-toggle="regular"]').hasClass('alert-danger') && !o.is.regular)
          || $('[data-toggle="regular"]').hasClass('alert-secondary')
        const activeFilter = ($('[data-toggle="active"]').hasClass('alert-success') && o.is.online)
          || ($('[data-toggle="active"]').hasClass('alert-danger') && !o.is.online)
          || $('[data-toggle="active"]').hasClass('alert-secondary')
        return subscriberFilter && followerFilter && regularFilter && activeFilter
      }), [function (o) {
        var split = viewers.sortBy.split('.')
        var sort
        if (split.length == 2) {
          sort = (!_.isUndefined(o[split[0]]) && !_.isUndefined(o[split[0]][split[1]])) ? o[split[0]][split[1]] :
            0
        } else {
          sort = !_.isUndefined(o[viewers.sortBy]) ? o[viewers.sortBy] : 0
        }
        if (viewers.sortBy !== 'username') {
          return parseFloat(sort === 'Prime' ? 0.1 : sort) // set Prime value as 0
        }
        return sort
      }])
      if (viewers.sortType === 'down') list = list.reverse()
      list = _.chunk(list, 50)
      var paging = $('.paging')
      var empty = false
      paging.empty()
      _.each(list, function (v, i) {
        if (list.length < 10) {
          paging.append('<li style="margin:0; padding: 8px 5px;" onclick="viewers.pagination(' + (i + 1) + ')" class="btn ' + (pagination === i + 1 ?
            'btn-primary' : 'btn-default') + '">' + (i + 1) + '</li>')
        } else {
          if ((i >= pagination - 3 && i < pagination + 2) || (i > list.length - 4) || i % 10 === Math.floor(list.length /
              10) || i < 3) {
            paging.append('<li style="margin:0; padding: 8px 5px;" onclick="viewers.pagination(' + (i + 1) + ')" class="btn ' + (pagination === i + 1 ?
              'btn-primary' : 'btn-default') + '">' + (i + 1) + '</li>')
            if (!(i + 1 > pagination - 2 && i + 1 < pagination + 2) || !(i + 1 > list.length - 4)) {
              empty = true
            }
          } else if (empty) {
            paging.append('<li class="btn btn-link disabled"></li>')
            empty = false
          }
        }
      })
      if (list.length === 0) {
        paging.append('<li onclick="viewers.pagination(1)" style="margin:0; padding: 8px 5px;" class="btn btn-primary">1</li>')
      }
      return list[pagination - 1];
    },
    deleteBitsAndTips: function (button, id) {
      if ($(button).attr('disabled')) return

      $(button).attr('disabled', 'disabled')
      $(button).toggleClass('btn-danger btn-info').text(commons.translate('deleting'))

      const popover = $(button).parents('.card').children('.card-body').children('.input-group')
      console.log(`users.${$(button).data('type')}.delete`, id.replace('tip-','').replace('bit-',''))
      this.socket.emit(`users.${$(button).data('type')}.delete`, id.replace('tip-','').replace('bit-',''), (err) => {
        if (err) {
        } else {
          $(button).toggleClass('btn-info btn-danger').text(commons.translate('done'))
          setTimeout(() => {
            $(`tr[data-viewer-tip-id="${id.replace('tip-','').replace('bit-','')}"]`).popover('hide')
            $(`tr[data-viewer-bit-id="${id.replace('tip-','').replace('bit-','')}"]`).popover('hide')
            viewers.updateUserBits($('#viewers_username').text())
            viewers.updateUserTips($('#viewers_username').text())
            socket.emit('getViewers')
          }, 1000)
        }
      })
    },
    updateBitsAndTips: function (button, id) {
      if ($(button).attr('disabled')) return

      $(button).attr('disabled', 'disabled')
      $(button).toggleClass('btn-primary btn-info').text(commons.translate('saving'))

      const popover = $(button).parents('.card').children('.card-body').children('.input-group')
      const inputs = $(popover).children('input')
      const textarea = $(popover).children('textarea')

      let data = {
        _id: id.replace('tip-','').replace('bit-',''),
        username: $('#viewers_username').text(),
        timestamp: $(inputs[0]).datetimepicker('date').format('x'),
        amount: $(inputs[1]).val(),
        message: $(textarea).val()
      }

      console.log(`users.${$(button).data('type')}.update`, data)
      this.socket.emit(`users.${$(button).data('type')}.update`, data, (err) => {
        if (err) {
          const errors = JSON.parse(err)

          if (!_.isNil(errors.amount)) {
            $(inputs[1]).addClass('is-invalid')
            $(inputs[1]).parents().find('.invalid-feedback').text(errors.amount)
          }

          $(button).toggleClass('btn-info btn-danger').text(commons.translate('error'))
          setTimeout(() => {
            $(button).toggleClass('btn-danger btn-primary').text(commons.translate('save-changes'))
            $(button).removeAttr('disabled')
          }, 1000)
        } else {
          $(button).toggleClass('btn-info btn-success').text(commons.translate('done'))
          setTimeout(() => {
            $(`tr[data-viewer-tip-id="${id.replace('tip-','').replace('bit-','')}"]`).popover('hide')
            $(`tr[data-viewer-bit-id="${id.replace('tip-','').replace('bit-','')}"]`).popover('hide')
            viewers.updateUserBits(data.username)
            viewers.updateUserTips(data.username)
            socket.emit('getViewers')
          }, 1000)
        }
      })
    },
    addBitsAndTips: function (button) {
      if ($(button).attr('disabled')) return

      $(button).attr('disabled', 'disabled')
      $(button).toggleClass('btn-primary btn-info').text(commons.translate('saving'))

      const popover = $(button).parents('.card').children('.card-body').children('.input-group')
      const inputs = $(popover).children('input')
      const textarea = $(popover).children('textarea')

      let data = {
        username: $('#viewers_username').text(),
        timestamp: $(inputs[0]).datetimepicker('date').format('x'),
        amount: $(inputs[1]).val(),
        message: $(textarea).val()
      }
      this.socket.emit(`users.${$(button).data('type')}.add`, data, (err) => {
        if (err) {
          const errors = JSON.parse(err)

          if (!_.isNil(errors.amount)) {
            $(inputs[1]).addClass('is-invalid')
            $(inputs[1]).parents().find('.invalid-feedback').text(errors.amount)
          }

          $(button).toggleClass('btn-info btn-danger').text(commons.translate('error'))
          setTimeout(() => {
            $(button).toggleClass('btn-danger btn-primary').text(commons.translate('save-changes'))
            $(button).removeAttr('disabled')
          }, 1000)
        } else {
          viewers.updateUserBits(data.username)
          viewers.updateUserTips(data.username)
          socket.emit('getViewers')
          $(button).toggleClass('btn-info btn-success').text(commons.translate('done'))
          setTimeout(() => {
            $(`#new_${$(button).data('type')}`).popover('hide')
          }, 1000)
        }
      })
    },
    updateUserBits: function (username) {
      $('#viewers_bits').empty()
      this.socket.emit('users.bits', username, (err, bits) => {
        if (err) return console.error(err)

        if (bits.length === 0) {
          $('#viewers_bits').append(`
            <tr>
              <td style="border-top: 0" colspan="3"><em class="text-info">No bits data were found for this user</em></td>
            </tr>
          `)
        }
        for (let bit of bits) {
          $('#viewers_bits').append(`
            <tr data-viewer-bit-id="${bit._id.toString()}">
              <td style="border-top: 0; width: 160px;">${viewers.styleFollowTime(bit.timestamp)}</td>
              <td style="border-top: 0" class="text-center"><strong>${parseInt(bit.amount, 10)}</strong></td>
              <td style="border-top: 0">${bit.message}</td>
            </tr>
          `)

          $(`tr[data-viewer-bit-id="${bit._id.toString()}"]`).popover({
            html: true,
            placement: 'auto',
            template: '<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body p-0"></div></div>',
            content: `
              <div class="card">
                <div class="card-body p-0">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-clock"></i></span>
                    </div>
                    <input type="text" class="form-control datetimepicker-input border-top-0 border-left-0 border-right-0" id="bit-${bit._id.toString()}"/>
                    <div class="invalid-feedback-popover invalid-feedback"></div>
                  </div>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-money-bill-alt"></i></span>
                    </div>
                    <input type="number" class="border-top-0 border-left-0 border-right-0 form-control" value="${parseInt(bit.amount, 10)}"/>4
                    <div class="invalid-feedback-popover invalid-feedback"></div>
                  </div>
                  <div class="input-group mb-1">
                    <div class="input-group-prepend">
                      <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-comment"></i></span>
                    </div>
                    <textarea rows="5" class="border-top-0 border-left-0 border-right-0 form-control">${bit.message}</textarea>
                    <div class="invalid-feedback-popover invalid-feedback"></div>
                  </div>
                </div>
                <div class="card-footer d-flex p-0 border-top-0">
                  <button class="btn btn-danger w-100" data-type="bits" onclick="viewers.deleteBitsAndTips(this, 'bit-${bit._id.toString()}')">${commons.translate('delete')}</button>
                  <button class="btn btn-primary w-100" data-type="bits" onclick="viewers.updateBitsAndTips(this, 'bit-${bit._id.toString()}')">${commons.translate('save-changes')}</button>
                </div>
              </div>
            `
          })
          $(`tr[data-viewer-bit-id="${bit._id.toString()}"]`).off('shown.bs.popover').on('shown.bs.popover', () => {
            $(`#bit-${bit._id.toString()}`).datetimepicker('destroy')
            $(`#bit-${bit._id.toString()}`).datetimepicker(datepickeropts)
            if (!_.isNil(bit.timestamp) && bit.timestamp > 0) $(`#bit-${bit._id.toString()}`).datetimepicker('defaultDate', viewers.styleFollowTime(bit.timestamp))
            else $(`#bit-${bit._id.toString()}`).datetimepicker('defaultDate', false)
            $(`#bit-${bit._id.toString()}`).off('click').on('click', () => $(`#bit-${bit._id.toString()}`).datetimepicker('toggle'))
            $(`#bit-${bit._id.toString()}`).off('blur').on('blur', () => $(`#bit-${bit._id.toString()}`).datetimepicker('hide'))
          })
        }
      })
    },
    updateUserTips: function (username) {
      $('#viewers_tips').empty()
      this.socket.emit('users.tips', username, (err, tips) => {
        if (err) return console.error(err)

        if (tips.length === 0) {
          $('#viewers_tips').append(`
            <tr>
              <td style="border-top: 0" colspan="3"><em class="text-info">No tips data were found for this user</em></td>
            </tr>
          `)
        }
        for (let tip of tips) {
          $('#viewers_tips').append(`
            <tr data-viewer-tip-id="${tip._id.toString()}">
              <td style="border-top: 0; width: 160px;">${viewers.styleFollowTime(tip.timestamp)}</td>
              <td style="border-top: 0" class="text-center"><strong>${parseFloat(tip.amount).toFixed(2)}${tip.currency}</strong></td>
              <td style="border-top: 0">${tip.message}</td>
            </tr>
          `)

          $(`tr[data-viewer-tip-id="${tip._id.toString()}"]`).popover({
            html: true,
            placement: 'auto',
            template: '<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body p-0"></div></div>',
            content: `
              <div class="card">
                <div class="card-body p-0">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-clock"></i></span>
                    </div>
                    <input type="text" class="form-control border-top-0 border-left-0 border-right-0" id="tip-${tip._id.toString()}"/>
                    <div class="invalid-feedback-popover invalid-feedback"></div>
                  </div>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-money-bill-alt"></i></span>
                    </div>
                    <input type="text" class="border-top-0 border-left-0 border-right-0 form-control" value="${parseFloat(tip.amount).toFixed(2)}${tip.currency}"/>
                    <div class="invalid-feedback-popover invalid-feedback"></div>
                  </div>
                  <div class="input-group mb-1">
                    <div class="input-group-prepend">
                      <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-comment"></i></span>
                    </div>
                    <textarea rows="5" class="border-top-0 border-left-0 border-right-0 form-control">${tip.message}</textarea>
                    <div class="invalid-feedback-popover invalid-feedback"></div>
                  </div>
                </div>
                <div class="card-footer d-flex p-0 border-top-0">
                  <button class="btn btn-danger w-100" data-type="tips" onclick="viewers.deleteBitsAndTips(this, 'tip-${tip._id.toString()}')">${commons.translate('delete')}</button>
                  <button class="btn btn-primary w-100" data-type="tips" onclick="viewers.updateBitsAndTips(this, 'tip-${tip._id.toString()}')">${commons.translate('save-changes')}</button>
                </div>
              </div>
            `
          })
          $(`tr[data-viewer-tip-id="${tip._id.toString()}"]`).off('shown.bs.popover').on('shown.bs.popover', () => {
            $(`#tip-${tip._id.toString()}`).datetimepicker('destroy')
            $(`#tip-${tip._id.toString()}`).datetimepicker(datepickeropts)
            if (!_.isNil(tip.timestamp) && tip.timestamp > 0) $(`#tip-${tip._id.toString()}`).datetimepicker('defaultDate', viewers.styleFollowTime(tip.timestamp))
            else $(`#tip-${tip._id.toString()}`).datetimepicker('defaultDate', false)
            $(`#tip-${tip._id.toString()}`).off('click').on('click', () => $(`#tip-${tip._id.toString()}`).datetimepicker('toggle'))
            $(`#tip-${tip._id.toString()}`).off('blur').on('blur', () => $(`#tip-${tip._id.toString()}`).datetimepicker('hide'))
          })
        }
      })
    }
  }

  function ViewersPage () {
    if (_.isNil(systems) || _.isNil(configuration)) {
      setTimeout(() => ViewersPage(), 1)
      return
    }
    var userSocket = io('/users', {
      query: "token=" + token
    });
    viewers.socket = userSocket

    if (!systems.points) {
      $("#viewers-points").remove()
    }

    $("#reset-points-of-all-users").off('click')
    $("#reset-points-of-all-users").on('click', function (ev) {
      ev.preventDefault()
      socket.emit('resetPoints')
      setTimeout(function () {
        socket.emit('getViewers')
      }, 1000)
    })

    $("#reset-watchtime-of-all-users").off('click')
    $("#reset-watchtime-of-all-users").on('click', function (ev) {
      ev.preventDefault()
      socket.emit('resetWatchTime')
      setTimeout(function () {
        socket.emit('getViewers')
      }, 1000)
    })

    $("#reset-messages-of-all-users").off('click')
    $("#reset-messages-of-all-users").on('click', function (ev) {
      ev.preventDefault()
      socket.emit('resetMessages')
      setTimeout(function () {
        socket.emit('getViewers')
      }, 1000)
    })

    $(document)
      .off('show.bs.tab', 'a[href="#ignorelist"]')
      .on('show.bs.tab', 'a[href="#ignorelist"]', () => {
        $('#users-search').addClass('d-none')
        userSocket.emit('ignore.list', (err, data) => {
          $('#ignorelist-textarea').val(!_.isEmpty(data) ? _.map(data, 'username').join('\n') : '')
        })
      })
    $(document)
      .off('show.bs.tab', 'a[href="#manage"]')
      .on('show.bs.tab', 'a[href="#manage"]', () => { $('#users-search').removeClass('d-none') })

    $('#ignorelist-submit').on('click', () => {
      let users = $('#ignorelist-textarea').val().split('\n')

      /* do fadeIn and hide button */
      $('#ignorelist-submit').velocity('fadeOut', { duration: 250 })
      $('#ignorelist-alert-info')
        .removeClass('d-none')
        .css('opacity', '0')
        .velocity('fadeIn', { duration: 250 })

      userSocket.emit('ignore.list.save', users, (err) => {
        $('#ignorelist-alert-info').velocity('fadeOut', { duration: 250 })
        if (err) {
          $('#ignorelist-alert-danger')
            .removeClass('d-none')
            .css('opacity', '0')
            .velocity('fadeIn', { delay: 500, duration: 250 })
            .velocity('fadeOut', { delay: 1000, duration: 250})
        } else {
          $('#ignorelist-alert-success')
            .removeClass('d-none')
            .css('opacity', '0')
            .velocity('fadeIn', { delay: 500, duration: 250 })
            .velocity('fadeOut', { delay: 1000, duration: 250})
        }
        $('#ignorelist-submit').velocity('fadeIn', { delay: 250, duration: 250 })
      })
    })


    socket.emit('getViewers')

    socket.off('Viewers')
    socket.on('Viewers', function (list) {
      viewers.list = JSON.parse(decodeURIComponent(Array.prototype.map.call(atob(list), function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      }).join('')))
      viewers.update(viewers.paging())
    });

    $('#viewersSearch').attr('placeholder', translations['search-by-username'])

    $("#viewersDlg").off('show.bs.modal').on('show.bs.modal', function (ev) {
      /* load up all viewer data */
      let viewer = _.find(viewers.list, (o) => String(o.username) === String($(ev.relatedTarget).data('username')))
      $('#viewers_username').text(viewer.username)
      $('#viewers_tier').val(viewer.stats.tier)

      /* toggles */
      $('#viewers_follower_toggle').removeClass().addClass((viewer.is.follower ? 'btn-success' : 'btn-danger') + ' btn w-100')
      $('#viewers_subscriber_toggle').removeClass().addClass((viewer.is.subscriber ? 'btn-success' : 'btn-danger') + ' btn w-100')
      $('#viewers_regular_toggle').removeClass().addClass((viewer.is.regular ? 'btn-success' : 'btn-danger') + ' btn w-100')

      $('#viewers_last_seen').datetimepicker(datepickeropts)
      $('#viewers_last_seen').datetimepicker('date', null)
      if (!_.isNil(viewer.time.message) && viewer.time.message > 0) $('#viewers_last_seen').datetimepicker('defaultDate', viewers.styleFollowTime(viewer.time.message))

      $('#viewers_followed_at').datetimepicker(datepickeropts)
      $('#viewers_followed_at').datetimepicker('date', null)
      if (!_.isNil(viewer.time.follow) && viewer.time.follow > 0) $('#viewers_followed_at').datetimepicker('defaultDate', viewers.styleFollowTime(viewer.time.follow))

      $('#viewers_subscribed_at').datetimepicker(datepickeropts)
      $('#viewers_subscribed_at').datetimepicker('date', null)
      if (!_.isNil(viewer.time.subscribed_at) && viewer.time.subscribed_at > 0) $('#viewers_subscribed_at').datetimepicker('defaultDate', viewers.styleFollowTime(viewer.time.subscribed_at))

      $('#viewers_watched').val(viewers.styleWatched(viewer.time.watched))
      $('#viewers_points').val(_.get(viewer, 'points', 0))
      $('#viewers_messages').val(_.get(viewer, 'stats.messages', 0))

      viewers.updateUserTips(viewer.username)
      viewers.updateUserBits(viewer.username)

      // set up new bit popover
      $(`#new_bits`).popover({
        html: true,
        placement: 'auto',
        template: '<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body p-0"></div></div>',
        content: `
          <div class="card">
            <div class="card-body p-0">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-clock"></i></span>
                </div>
                <input type="text" class="form-control border-top-0 border-left-0 border-right-0" id="bit-new"/>
                <div class="invalid-feedback-popover invalid-feedback"></div>
              </div>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-money-bill-alt"></i></span>
                </div>
                <input type="number" class="border-top-0 border-left-0 border-right-0 form-control" value="50"/>
                <div class="invalid-feedback-popover invalid-feedback"></div>
              </div>
              <div class="input-group mb-1">
                <div class="input-group-prepend">
                  <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-comment"></i></span>
                </div>
                <textarea rows="5" class="border-top-0 border-left-0 border-right-0 form-control"></textarea>
                <div class="invalid-feedback-popover invalid-feedback"></div>
              </div>
            </div>
            <div class="card-footer d-flex p-0 border-top-0">
              <button class="btn btn-warning w-100" onclick="$('#new_bits').popover('hide')">${commons.translate('close')}</button>
              <button class="btn btn-primary w-100" onclick="viewers.addBitsAndTips(this)" data-type="bits">${commons.translate('save-changes')}</button>
            </div>
          </div>
        `
      })
      $(`#new_bits`).off('shown.bs.popover').on('shown.bs.popover', () => {
        $(`#bit-new`).datetimepicker('destroy')
        $(`#bit-new`).datetimepicker(datepickeropts)
        $(`#bit-new`).datetimepicker('defaultDate', viewers.styleFollowTime(_.now()))
        $(`#bit-new`).off('click').on('click', () => $(`#bit-new`).datetimepicker('toggle'))
        $(`#bit-new`).off('blur').on('blur', () => $(`#bit-new`).datetimepicker('hide'))
      })
    })

    // set up new tip popover
    $(`#new_tips`).popover({
      html: true,
      placement: 'auto',
      template: '<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-body p-0"></div></div>',
      content: `
        <div class="card">
          <div class="card-body p-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-clock"></i></span>
              </div>
              <input type="text" class="form-control border-top-0 border-left-0 border-right-0" id="tip-new"/>
              <div class="invalid-feedback-popover invalid-feedback"></div>
            </div>
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-money-bill-alt"></i></span>
              </div>
              <input type="text" class="border-top-0 border-left-0 border-right-0 form-control" id="viewers_tip" value="50.00${configuration.currency}"/>
              <div class="invalid-feedback-popover invalid-feedback"></div>
            </div>
            <div class="input-group mb-1">
              <div class="input-group-prepend">
                <span class="border-top-0 border-left-0 border-right-0 input-group-text"><i class="far fa-fw fa-comment"></i></span>
              </div>
              <textarea rows="5" class="border-top-0 border-left-0 border-right-0 form-control"></textarea>
              <div class="invalid-feedback-popover invalid-feedback"></div>
            </div>
          </div>
          <div class="card-footer d-flex p-0 border-top-0">
            <button class="btn btn-warning w-100" onclick="$('#new_tips').popover('hide')">${commons.translate('close')}</button>
            <button class="btn btn-primary w-100" id="new_tips_submit_button" onclick="viewers.addBitsAndTips(this)" data-type="tips">${commons.translate('save-changes')}</button>
          </div>
        </div>
      `
    })
    $(`#new_tips`).off('shown.bs.popover').on('shown.bs.popover', () => {
      $(`#tip-new`).datetimepicker('destroy')
      $(`#tip-new`).datetimepicker(datepickeropts)
      $(`#tip-new`).datetimepicker('defaultDate', viewers.styleFollowTime(_.now()))
      $(`#tip-new`).off('click').on('click', () => $(`#tip-new`).datetimepicker('toggle'))
      $(`#tip-new`).off('blur').on('blur', () => $(`#tip-new`).datetimepicker('hide'))
    })

    $('#viewers_follower_toggle, #viewers_subscriber_toggle, #viewers_regular_toggle').off('click').on('click', (ev) => {
      let id = $(ev.currentTarget).attr('id')
      $(`#${id}`).toggleClass('btn-success btn-danger')
    })
  }

  ViewersPage()

</script>
